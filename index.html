<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Colombia | Dashboard de Radiación</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --accent: #fbbf24;
            --accent-glow: rgba(251, 191, 36, 0.3);
        }
        body {
            background-color: var(--bg-dark);
            font-family: 'Outfit', sans-serif;
            color: #f8fafc;
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        .text-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats-badge {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        select, button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #map-container {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
<base target="_blank">
</head>
<body class="p-4 md:p-6">
    <div class="max-w-[1600px] mx-auto space-y-6">
        <!-- Premium Header -->
        <header class="flex flex-col md:flex-row items-center justify-between gap-6 pb-2 border-b border-white/10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-xl flex items-center justify-center shadow-lg shadow-orange-500/20">
                    <i class="fas fa-sun text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight">
                        <span class="text-white">Solar</span><span class="text-gradient">Colombia</span>
                    </h1>
                    <p class="text-slate-400 text-sm font-medium">Interpolación Kriging • Geoprocesamiento IDEAM</p>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-3">
                <!-- Play Button -->
                <button id="btn-play" onclick="togglePlay()" 
                        class="flex items-center gap-2 px-5 py-2.5 bg-emerald-500/10 hover:bg-emerald-500 text-emerald-400 hover:text-white border border-emerald-500/20 rounded-full font-semibold text-sm transition-all duration-300">
                    <i class="fas fa-play"></i>
                    <span>Reproducir Año</span>
                </button>

                <!-- Month Selector -->
                <div class="relative min-w-[180px]">
                    <select id="month-selector" onchange="updateMap(this.value)" 
                            class="w-full bg-slate-800 text-white border border-slate-700 px-4 py-2.5 rounded-full text-sm font-semibold appearance-none cursor-pointer hover:border-slate-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50">
                        <option value="ENE">Enero</option>
                        <option value="FEB">Febrero</option>
                        <option value="MAR">Marzo</option>
                        <option value="ABR">Abril</option>
                        <option value="MAY">Mayo</option>
                        <option value="JUN">Junio</option>
                        <option value="JUL">Julio</option>
                        <option value="AGO">Agosto</option>
                        <option value="SEP">Septiembre</option>
                        <option value="OCT">Octubre</option>
                        <option value="NOV">Noviembre</option>
                        <option value="DIC">Diciembre</option>
                        <option value="Annual">Promedio Anual</option>
                    </select>
                    <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></i>
                </div>

                <!-- Toggle Stations -->
                <button id="btn-stations" onclick="toggleStations()" 
                        class="flex items-center gap-2 px-5 py-2.5 bg-slate-800 border border-slate-700 text-slate-300 hover:text-white rounded-full font-semibold text-sm transition-all">
                    <i id="station-icon" class="fas fa-location-dot text-red-500"></i>
                    <span>Estaciones</span>
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh-160px)] min-h-[600px]">
            <!-- Map Area -->
            <div class="lg:col-span-3 relative group">
                <div id="map-container" class="w-full h-full bg-slate-900 border border-white/5"></div>
                <!-- Legend Floating -->
                <div class="absolute bottom-8 left-8 glass-card px-4 py-3 flex flex-col gap-2 shadow-2xl pointer-events-none">
                    <span class="text-[10px] uppercase tracking-widest font-bold text-slate-400">Radiación (kWh/m²)</span>
                    <div class="h-2 w-48 bg-gradient-to-r from-blue-600 via-yellow-400 to-red-600 rounded-full"></div>
                    <div class="flex justify-between text-[10px] font-bold text-slate-300">
                        <span>1.5</span>
                        <span>4.0</span>
                        <span>6.5+</span>
                    </div>
                </div>
            </div>

            <!-- Dashboard Sidebar -->
            <div class="flex flex-col gap-6">
                <!-- Statistics Card -->
                <section class="glass-card p-6 flex-1 flex flex-col overflow-hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-chart-line text-orange-500"></i>
                            Análisis Espacial
                        </h3>
                    </div>
                    
                    <div id="stats-container" class="space-y-6 overflow-y-auto pr-2">
                        <div class="flex justify-center py-12">
                            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-orange-500"></div>
                        </div>
                    </div>
                </section>

                <!-- Technical Details -->
                <section class="glass-card p-6 min-h-[140px]">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-microchip"></i>
                        Metodología
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stats-badge p-3 rounded-xl text-center">
                            <p class="text-slate-400 text-[10px] uppercase font-bold">Modelo</p>
                            <p class="text-white text-xs font-bold mt-1">OK Spherical</p>
                        </div>
                        <div class="stats-badge p-3 rounded-xl text-center">
                            <p class="text-slate-400 text-[10px] uppercase font-bold">Malla</p>
                            <p class="text-white text-xs font-bold mt-1">8,000 Puntos</p>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-4 leading-relaxed italic">
                        Los valores fuera del límite nacional han sido removidos mediante máscara geográfica para precisión territorial.
                    </p>
                </section>
            </div>
        </main>
    </div>

    <script>
        let currentMonth = 'ENE';
        let stationsVisible = true;
        let playInterval = null;
        let isPlaying = false;
        const monthsOrder = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC', 'Annual'];

        async function initializeMap() {
            try {
                // Cargar datos
                const [csvRes, krigingRes] = await Promise.all([
                    fetch('radiation_data.csv'),
                    fetch('kriging_data.json')
                ]);
                
                if (!csvRes.ok || !krigingRes.ok) throw new Error('Error al cargar recursos');
                
                const csvText = await csvRes.text();
                window.globalData = parseCSV(csvText);
                window.krigingData = await krigingRes.json();
                
                await updateMap('ENE');
            } catch (error) {
                console.error("Init Error:", error);
                document.getElementById('map-container').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-400 p-8 text-center">
                        <i class="fas fa-triangle-exclamation text-4xl mb-4"></i>
                        <p class="font-bold">Error de Inicialización</p>
                        <p class="text-xs opacity-60 mt-2">${error.message}</p>
                    </div>`;
            }
        }

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const result = [];
            for(let i=1; i<lines.length; i++) {
                const line = lines[i].trim();
                if(!line) continue;
                const row = line.split(','); // Simplified for internal logic
                if (row.length < 25) continue;
                result.push({
                    name: row[1], dept: row[3],
                    lat: parseFloat(row[4]), lon: parseFloat(row[5]),
                    ENE: parseFloat(row[8]), FEB: parseFloat(row[9]),
                    MAR: parseFloat(row[10]), ABR: parseFloat(row[11]),
                    MAY: parseFloat(row[12]), JUN: parseFloat(row[13]),
                    JUL: parseFloat(row[14]), AGO: parseFloat(row[15]),
                    SEP: parseFloat(row[16]), OCT: parseFloat(row[17]),
                    NOV: parseFloat(row[18]), DIC: parseFloat(row[19]),
                    Annual: parseFloat(row[24])
                });
            }
            return result;
        }

        async function updateMap(month) {
            currentMonth = month;
            const selector = document.getElementById('month-selector');
            if (selector) selector.value = month;

            const dataKey = (month === 'Annual') ? 'Annual_Average' : month;
            const krigingZ = window.krigingData.data[dataKey];

            // Preparar Malla Filtrada
            const flatLats = [], flatLons = [], flatZ = [];
            for (let i = 0; i < window.krigingData.lat.length; i++) {
                for (let j = 0; j < window.krigingData.lon.length; j++) {
                    const val = krigingZ[i][j];
                    if (val !== null) {
                        flatLats.push(window.krigingData.lat[i]);
                        flatLons.push(window.krigingData.lon[j]);
                        flatZ.push(val);
                    }
                }
            }

            const stations = window.globalData;
            const validVals = stations.map(s => s[month]).filter(v => !isNaN(v));
            const cMin = Math.min(...validVals), cMax = Math.max(...validVals);

            const krigingTrace = {
                type: 'densitymapbox',
                lat: flatLats, lon: flatLons, z: flatZ,
                radius: 15, // Radio ajustado para el nuevo zoom
                colorscale: 'Jet',
                opacity: 0.8,
                showscale: false,
                hoverinfo: 'none'
            };

            const stationsTrace = {
                type: 'scattermapbox',
                lat: stations.map(s => s.lat), lon: stations.map(s => s.lon),
                mode: 'markers',
                marker: {
                    size: 6,
                    color: stations.map(s => s[month]),
                    colorscale: 'Jet',
                    cmin: cMin, cmax: cMax,
                    showscale: true,
                    line: { color: 'rgba(255,255,255,0.2)', width: 0.5 },
                    colorbar: {
                        thickness: 10, len: 0.5,
                        y: 0.5, yanchor: 'middle',
                        tickfont: { color: '#94a3b8', size: 10 },
                        title: { text: 'kWh/m²', font: { color: '#94a3b8', size: 10 } }
                    }
                },
                text: stations.map(s => `<b>${s.name}</b><br>${s.dept}<br>${s[month].toFixed(2)} kWh/m²`),
                hoverinfo: 'text',
                visible: stationsVisible
            };

            const layout = {
                mapbox: {
                    style: 'carto-darkmatter', // Estilo Premium Oscuro
                    center: { lat: 4.2, lon: -74.5 }, // Centro optimizado
                    zoom: 4.0 // Zoom con más aire
                },
                margin: { t: 0, b: 0, l: 0, r: 0 },
                showlegend: false,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('map-container', [krigingTrace, stationsTrace], layout, { responsive: true, displayModeBar: false });
            updateStats(validVals, month);
        }

        function updateStats(values, month) {
            values.sort((a, b) => a - b);
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const min = values[0], max = values[values.length - 1];
            const p90 = values[Math.floor(values.length * 0.9)];
            
            let potential = 'Moderado';
            let color = 'text-yellow-400';
            if (mean > 5.0) { potential = 'Excelente'; color = 'text-emerald-400'; }
            else if (mean > 4.2) { potential = 'Alto'; color = 'text-orange-400'; }

            document.getElementById('stats-container').innerHTML = `
                <div class="stats-badge p-4 rounded-2xl mb-4 text-center">
                    <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Potencial Solar</p>
                    <p class="text-2xl font-black ${color}">${potential}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Promedio</p>
                        <p class="text-xl font-bold">${mean.toFixed(2)}</p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Máximo</p>
                        <p class="text-xl font-bold">${max.toFixed(2)}</p>
                    </div>
                </div>

                <div class="space-y-3 mt-4">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-400">Escala de Eficiencia (P90)</span>
                        <span class="font-bold text-emerald-400">${p90.toFixed(2)}</span>
                    </div>
                    <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full bg-emerald-500" style="width: ${(p90/7*100).toFixed(0)}%"></div>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-400">Variabilidad (Mín-Máx)</span>
                        <span class="font-bold text-orange-400">${(max-min).toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        function togglePlay() {
            const btn = document.getElementById('btn-play');
            isPlaying = !isPlaying;
            if (isPlaying) {
                btn.classList.add('bg-red-500/10', 'border-red-500/20', 'text-red-400');
                btn.classList.remove('bg-emerald-500/10', 'border-emerald-500/20', 'text-emerald-400');
                btn.innerHTML = '<i class="fas fa-pause"></i><span>Pausar</span>';
                playInterval = setInterval(() => {
                    let next = (monthsOrder.indexOf(currentMonth) + 1) % 12;
                    updateMap(monthsOrder[next]);
                }, 1500);
            } else {
                clearInterval(playInterval);
                btn.classList.remove('bg-red-500/10', 'border-red-500/20', 'text-red-400');
                btn.classList.add('bg-emerald-500/10', 'border-emerald-500/20', 'text-emerald-400');
                btn.innerHTML = '<i class="fas fa-play"></i><span>Reproducir Año</span>';
            }
        }

        function toggleStations() {
            stationsVisible = !stationsVisible;
            const icon = document.getElementById('station-icon');
            icon.className = stationsVisible ? 'fas fa-location-dot text-red-500' : 'fas fa-location-dot text-slate-500';
            updateMap(currentMonth);
        }

        document.addEventListener('DOMContentLoaded', initializeMap);
    </script>
</body>
</html>