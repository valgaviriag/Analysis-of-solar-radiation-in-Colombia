<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Colombia | Dashboard de Radiación</title>
    <!-- Seguridad: SRI para librerías externas -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --accent: #fbbf24;
            --accent-glow: rgba(251, 191, 36, 0.3);
        }
        body {
            background-color: var(--bg-dark);
            font-family: 'Outfit', sans-serif;
            color: #f8fafc;
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        .text-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats-badge {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        select, button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #map-container {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
<base target="_blank">
</head>
<body class="p-4 md:p-6">
    <div class="max-w-[1600px] mx-auto space-y-6">
        <!-- Premium Header -->
        <header class="flex flex-col md:flex-row items-center justify-between gap-6 pb-2 border-b border-white/10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-xl flex items-center justify-center shadow-lg shadow-orange-500/20">
                    <i class="fas fa-sun text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight">
                        <span class="text-white">Solar</span><span class="text-gradient">Colombia</span>
                    </h1>
                    <p class="text-slate-400 text-sm font-medium">Análisis Espacial de Radiación • Red de estaciones IDEAM</p>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-3">
                <!-- Play Button -->
                <button id="btn-play" onclick="togglePlay()" 
                        class="flex items-center gap-2 px-5 py-2.5 bg-emerald-500/10 hover:bg-emerald-500 text-emerald-400 hover:text-white border border-emerald-500/20 rounded-full font-semibold text-sm transition-all duration-300">
                    <i class="fas fa-play"></i>
                    <span>Reproducir Año</span>
                </button>

                <!-- Month Selector -->
                <div class="relative min-w-[180px]">
                    <select id="month-selector" onchange="updateMap(this.value)" 
                            class="w-full bg-slate-800 text-white border border-slate-700 px-4 py-2.5 rounded-full text-sm font-semibold appearance-none cursor-pointer hover:border-slate-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50">
                        <option value="ENE">Enero</option>
                        <option value="FEB">Febrero</option>
                        <option value="MAR">Marzo</option>
                        <option value="ABR">Abril</option>
                        <option value="MAY">Mayo</option>
                        <option value="JUN">Junio</option>
                        <option value="JUL">Julio</option>
                        <option value="AGO">Agosto</option>
                        <option value="SEP">Septiembre</option>
                        <option value="OCT">Octubre</option>
                        <option value="NOV">Noviembre</option>
                        <option value="DIC">Diciembre</option>
                        <option value="Annual">Promedio Anual</option>
                    </select>
                    <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></i>
                </div>

                <!-- Toggle Stations -->
                <button id="btn-stations" onclick="toggleStations()" 
                        class="flex items-center gap-2 px-5 py-2.5 bg-slate-800 border border-slate-700 text-slate-300 hover:text-white rounded-full font-semibold text-sm transition-all">
                    <i id="station-icon" class="fas fa-location-dot text-red-500"></i>
                    <span>Estaciones</span>
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6 h-[calc(100vh-260px)] min-h-[500px]">
            <!-- Map Area -->
            <div class="lg:col-span-4 relative group">
                <div id="map-container" class="w-full h-full bg-slate-900 border border-white/5"></div>
            </div>

            <!-- Dashboard Sidebar -->
            <div class="flex flex-col gap-6">
                <!-- Statistics Card -->
                <section class="glass-card pt-4 px-4 pb-4 flex-1 flex flex-col overflow-hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-bold flex items-center gap-2">
                            <i class="fas fa-chart-line text-orange-500"></i>
                            Análisis Espacial
                        </h3>
                    </div>
                    
                    <div id="stats-container" class="space-y-2.5 overflow-y-auto pr-1">
                        <div class="flex justify-center py-12">
                            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-orange-500"></div>
                        </div>
                    </div>
                </section>

                <!-- Technical Details -->
                <section class="glass-card p-6 min-h-[140px]">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-microchip"></i>
                        Metodología
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stats-badge p-3 rounded-xl text-center">
                            <p class="text-slate-400 text-[10px] uppercase font-bold">Modelo</p>
                            <p class="text-white text-xs font-bold mt-1">OK Spherical</p>
                        </div>
                        <div class="stats-badge p-3 rounded-xl text-center">
                            <p class="text-slate-400 text-[10px] uppercase font-bold">Malla</p>
                            <p class="text-white text-xs font-bold mt-1">8,000 Puntos</p>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-4 leading-relaxed italic">
                        Los valores fuera del límite nacional han sido removidos mediante máscara geográfica para precisión territorial.
                    </p>
                </section>
            </div>
        </main>
    </div>

    <script>
        let currentMonth = 'ENE';
        let stationsVisible = true;
        let playInterval = null;
        let isPlaying = false;
        const monthsOrder = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC', 'Annual'];

        async function initializeMap() {
            try {
                // Cargar datos
                const [csvRes, krigingRes] = await Promise.all([
                    fetch('radiation_data.csv'),
                    fetch('kriging_data.json')
                ]);
                
                if (!csvRes.ok || !krigingRes.ok) throw new Error('Error al cargar recursos');
                
                const csvText = await csvRes.text();
                window.globalData = parseCSV(csvText);
                window.krigingData = await krigingRes.json();
                
                await updateMap('ENE');
            } catch (error) {
                console.error("Init Error:", error);
                document.getElementById('map-container').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-400 p-8 text-center">
                        <i class="fas fa-triangle-exclamation text-4xl mb-4"></i>
                        <p class="font-bold">Error de Inicialización</p>
                        <p class="text-xs opacity-60 mt-2">${error.message}</p>
                    </div>`;
            }
        }

        // Seguridad: Función para escapar HTML y prevenir XSS
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
            }[m]));
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length < 2) return [];

            // Regex para separar por comas respetando el contenido entre comillas
            const splitMapped = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let char of line) {
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else current += char;
                }
                result.push(current.trim());
                return result;
            };

            const headers = splitMapped(lines[0]);
            const result = [];
            
            for(let i = 1; i < lines.length; i++) {
                const row = splitMapped(lines[i]);
                if (row.length < headers.length) continue;

                const entry = {};
                headers.forEach((header, index) => {
                    let val = row[index];
                    if (['Latitud', 'Longitud', 'ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC', 'Annual_Average'].includes(header)) {
                        entry[header] = parseFloat(val.replace(',', '.'));
                    } else {
                        entry[header] = escapeHTML(val);
                    }
                });

                result.push({
                    name: entry['Estacion'] || 'Sin Nombre',
                    dept: entry['Departamento'] || 'N/A',
                    lat: entry['Latitud'],
                    lon: entry['Longitud'],
                    ENE: entry['ENE'], FEB: entry['FEB'], MAR: entry['MAR'], ABR: entry['ABR'],
                    MAY: entry['MAY'], JUN: entry['JUN'], JUL: entry['JUL'], AGO: entry['AGO'],
                    SEP: entry['SEP'], OCT: entry['OCT'], NOV: entry['NOV'], DIC: entry['DIC'],
                    Annual: entry['Annual_Average']
                });
            }
            return result;
        }

        async function updateMap(month) {
            currentMonth = month;
            const selector = document.getElementById('month-selector');
            if (selector) selector.value = month;

            const dataKey = (month === 'Annual') ? 'Annual_Average' : month;
            const stations = window.globalData;
            const monthValues = stations.map(s => s[month]).filter(v => !isNaN(v));
            
            // Líneas de escala fijas para consistencia temporal
            const globalMin = 1.5;
            const globalMax = 6.5;

            // Re-procesar la malla Kriging para esta visualización
            const flatLats = [], flatLons = [], flatZ = [];
            const krigingZ = window.krigingData.data[dataKey];
            
            if (krigingZ) {
                for (let i = 0; i < window.krigingData.lat.length; i++) {
                    for (let j = 0; j < window.krigingData.lon.length; j++) {
                        const val = krigingZ[i][j];
                        if (val !== null && val !== undefined) {
                            flatLats.push(window.krigingData.lat[i]);
                            flatLons.push(window.krigingData.lon[j]);
                            flatZ.push(val);
                        }
                    }
                }
            }

            const krigingTrace = {
                type: 'densitymapbox',
                lat: flatLats,
                lon: flatLons,
                z: flatZ,
                radius: 10, // Punto medio para evitar saturación y huecos
                colorscale: 'Jet',
                zmin: globalMin,
                zmax: globalMax,
                opacity: 0.6,
                showscale: false,
                hoverinfo: 'none'
            };

            const stationsTrace = {
                type: 'scattermapbox',
                lat: stations.map(s => s.lat), 
                lon: stations.map(s => s.lon),
                mode: 'markers',
                marker: {
                    size: 8,
                    color: stations.map(s => s[month]),
                    colorscale: 'Jet',
                    cmin: globalMin, cmax: globalMax,
                    showscale: true,
                    line: { color: 'white', width: 1 },
                    colorbar: {
                        thickness: 15,
                        len: 0.5,
                        title: { text: 'kWh/m²', font: { color: '#94a3b8' } },
                        tickfont: { color: '#94a3b8' }
                    }
                },
                text: stations.map(s => `<b>${s.name}</b><br>${s[month].toFixed(2)} kWh/m²`),
                hoverinfo: 'text',
                visible: stationsVisible
            };

            const layout = {
                mapbox: {
                    style: 'carto-darkmatter', // Estilo Premium Oscuro
                    center: { lat: 4.2, lon: -74.5 }, // Centro optimizado
                    zoom: 4.0 // Zoom con más aire
                },
                margin: { t: 0, b: 0, l: 0, r: 0 },
                showlegend: false,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            if (flatZ.length > 0) {
                // Rendimiento: Plotly.react actualiza solo los cambios, evitando recrear el DOM
                Plotly.react('map-container', [krigingTrace, stationsTrace], layout, { responsive: true, displayModeBar: false });
                // Análisis Espacial Real: Usamos la malla (flatZ) en lugar de solo las estaciones
                updateStats(flatZ, month);
            } else {
                console.warn("No hay datos para el mes:", month);
            }
        }

        function updateStats(values, month) {
            if (!values || values.length === 0) return;

            // 1. Estadísticas Geoespaciales sobre la superficie total
            values.sort((a, b) => a - b);
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const max = values[values.length - 1];
            const min = values[0];
            
            // P90 Real: Valor que el 90% del territorio supera (Percentil 10)
            const p90 = values[Math.floor(values.length * 0.1)];
            
            // Umbrales oficiales IDEAM/UPME para Colombia
            let potential = 'Bajo';
            let color = 'text-red-400';
            let bg = 'bg-red-500/10';
            
            if (mean > 5.5) { 
                potential = 'Excelente'; color = 'text-emerald-400'; bg = 'bg-emerald-500/10'; 
            } else if (mean > 4.5) { 
                potential = 'Alto'; color = 'text-orange-400'; bg = 'bg-orange-500/10'; 
            } else if (mean > 3.5) { 
                potential = 'Moderado'; color = 'text-yellow-400'; bg = 'bg-yellow-500/10'; 
            }

            // 2. Líder Regional (Departamento con el valor pico más alto)
            let maxStationVal = -1;
            let leaderDept = 'N/A';
            
            window.globalData.forEach(s => {
                const val = s[month];
                if (!isNaN(val) && val > maxStationVal) {
                    maxStationVal = val;
                    leaderDept = s.dept;
                }
            });

            const leader = { name: leaderDept, val: maxStationVal };

            // 3. Renderizado del Panel
            document.getElementById('stats-container').innerHTML = `
                <!-- Badge de Potencial -->
                <div class="${bg} p-2.5 rounded-xl mb-2 border border-white/5 text-center transition-all">
                    <p class="text-[10px] uppercase font-bold text-slate-400 mb-0.5 tracking-widest">Potencial Solar</p>
                    <p class="text-lg font-black ${color}">${potential}</p>
                </div>
                
                <!-- KPIs Principales -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="bg-white/5 p-2 rounded-xl border border-white/5 text-center">
                        <p class="text-[9px] text-slate-400 uppercase font-bold tracking-tighter">Promedio</p>
                        <p class="text-sm font-bold text-white">${mean.toFixed(2)}</p>
                    </div>
                    <div class="bg-white/5 p-2 rounded-xl border border-white/5 text-center">
                        <p class="text-[9px] text-slate-400 uppercase font-bold tracking-tighter">Máximo</p>
                        <p class="text-sm font-bold text-white">${max.toFixed(2)}</p>
                    </div>
                </div>

                <!-- Líder Departamental -->
                <div class="mb-2">
                    <h4 class="text-[9px] uppercase font-bold text-slate-500 mb-2 tracking-widest flex items-center gap-2">
                        <i class="fas fa-crown text-yellow-500 text-[8px]"></i> Líder Regional
                    </h4>
                    <div class="p-2 bg-gradient-to-br from-white/10 to-transparent rounded-xl border border-white/10 flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="text-[12px] font-bold text-white tracking-tight">${leader.name}</span>
                            <span class="text-[8px] uppercase font-bold text-slate-500">Valor Pico</span>
                        </div>
                        <div class="text-right">
                            <span class="text-base font-black text-orange-400">${leader.val.toFixed(2)}</span>
                            <span class="text-[8px] block font-bold text-slate-500">kWh/m²</span>
                        </div>
                    </div>
                </div>

                <!-- Eficiencia y Calidad -->
                <div class="space-y-2 pt-1 border-t border-white/5">
                    <div class="flex justify-between items-center text-[9px]">
                        <span class="text-slate-400 uppercase font-bold text-[9px]">Índice P90 (Garantía)</span>
                        <span class="font-bold text-emerald-400">${p90.toFixed(2)}</span>
                    </div>
                    <div class="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-emerald-600 to-emerald-400" style="width: ${(p90/7*100).toFixed(0)}%"></div>
                    </div>
                    
                    <div class="flex justify-between items-center text-[9px]">
                        <span class="text-slate-400 uppercase font-bold text-[9px]">Variabilidad Nac.</span>
                        <span class="font-bold text-orange-400">${(max-min).toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        function togglePlay() {
            const btn = document.getElementById('btn-play');
            isPlaying = !isPlaying;
            if (isPlaying) {
                btn.classList.add('bg-red-500/10', 'border-red-500/20', 'text-red-400');
                btn.classList.remove('bg-emerald-500/10', 'border-emerald-500/20', 'text-emerald-400');
                btn.innerHTML = '<i class="fas fa-pause"></i><span>Pausar</span>';
                playInterval = setInterval(() => {
                    let next = (monthsOrder.indexOf(currentMonth) + 1) % 12;
                    updateMap(monthsOrder[next]);
                }, 1500);
            } else {
                clearInterval(playInterval);
                btn.classList.remove('bg-red-500/10', 'border-red-500/20', 'text-red-400');
                btn.classList.add('bg-emerald-500/10', 'border-emerald-500/20', 'text-emerald-400');
                btn.innerHTML = '<i class="fas fa-play"></i><span>Reproducir Año</span>';
            }
        }

        function toggleStations() {
            stationsVisible = !stationsVisible;
            const icon = document.getElementById('station-icon');
            icon.className = stationsVisible ? 'fas fa-location-dot text-red-500' : 'fas fa-location-dot text-slate-500';
            updateMap(currentMonth);
        }

        document.addEventListener('DOMContentLoaded', initializeMap);
    </script>
</body>
</html>